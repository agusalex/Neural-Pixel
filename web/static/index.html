<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Neural-Pixel Web (Vulkan sd.cpp)</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <header>
      <h1>Neural-Pixel Web</h1>
      <p>A1111-compatible API (subset) backed by Vulkan sd.cpp</p>
    </header>

    <main class="container">
      <section class="panel">
        <h2>Text-to-Image</h2>
        <div class="grid">
          <label>Prompt<textarea id="prompt" rows="4"></textarea></label>
          <label>Negative Prompt<textarea id="neg_prompt" rows="4"></textarea></label>

          <label>Model<select id="model"></select></label>
          <label>VAE<select id="vae"></select></label>

          <label>Sampler<select id="sampler"></select></label>
          <label>Scheduler<select id="scheduler"></select></label>

          <label>Steps<input id="steps" type="number" min="1" max="60" value="30" /></label>
          <label>CFG<input id="cfg" type="number" step="0.5" value="6" /></label>

          <label>Width<select id="width"></select></label>
          <label>Height<select id="height"></select></label>

          <label>Batch<input id="batch" type="number" min="1" max="8" value="1" /></label>
          <label>Seed<input id="seed" type="number" value="-1" /></label>

          <label><input id="cpu" type="checkbox" /> Run on CPU</label>
          <label><input id="tiling" type="checkbox" /> VAE Tiling</label>
          <label><input id="clip_cpu" type="checkbox" /> Keep CLIP on CPU</label>
          <label><input id="vae_cpu" type="checkbox" /> Keep VAE on CPU</label>
          <label><input id="fa" type="checkbox" /> Diffusion Flash Attention</label>
        </div>
        <button id="run">Generate</button>
      </section>

      <section class="panel">
        <h2>Result</h2>
        <div id="result"></div>
      </section>
    </main>

    <script>
      async function fetchJSON(url) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      function option(text, value) {
        const o = document.createElement('option');
        o.textContent = text; o.value = value; return o;
      }

      async function init() {
        // Resolutions
        const resolutions = [64,128,192,256,320,384,448,512,576,640,704,768,832,896,960,1024,1088,1152,1216,1280];
        const w = document.getElementById('width');
        const h = document.getElementById('height');
        resolutions.forEach(r => { w.appendChild(option(r, r)); h.appendChild(option(r, r)); });
        w.value = 512; h.value = 512;

        // Samplers
        const samplers = await fetchJSON('/sdapi/v1/samplers');
        const s = document.getElementById('sampler');
        samplers.forEach(x => s.appendChild(option(x.name, x.name)));
        s.value = 'dpm++2m';

        // Schedulers
        const scheds = await fetchJSON('/sdapi/v1/schedulers');
        const sch = document.getElementById('scheduler');
        scheds.forEach(x => sch.appendChild(option(x.name, x.name)));
        sch.value = 'karras';

        // Models
        const models = await fetchJSON('/sdapi/v1/sd-models');
        const m = document.getElementById('model');
        m.appendChild(option('None', ''));
        models.forEach(x => m.appendChild(option(x.title, x.title)));

        // VAE list
        const vae = document.getElementById('vae');
        vae.appendChild(option('None', ''));
        try {
          const vaes = await fetchJSON('/sdapi/v1/sd-vae');
          vaes.forEach(x => vae.appendChild(option(x.filename, x.filename)));
        } catch (e) {
          console.warn('No VAE list available:', e);
        }
      }

      async function run() {
        const body = {
          prompt: document.getElementById('prompt').value,
          negative_prompt: document.getElementById('neg_prompt').value,
          steps: parseInt(document.getElementById('steps').value, 10),
          sampler_name: document.getElementById('sampler').value,
          scheduler: document.getElementById('scheduler').value,
          width: parseInt(document.getElementById('width').value, 10),
          height: parseInt(document.getElementById('height').value, 10),
          batch_size: parseInt(document.getElementById('batch').value, 10),
          cfg_scale: parseFloat(document.getElementById('cfg').value),
          seed: parseInt(document.getElementById('seed').value, 10),
          model: document.getElementById('model').value || null,
          vae: document.getElementById('vae').value || null,
          cpu: document.getElementById('cpu').checked,
          tiling: document.getElementById('tiling').checked,
          keep_clip_on_cpu: document.getElementById('clip_cpu').checked,
          keep_vae_on_cpu: document.getElementById('vae_cpu').checked,
          diffusion_fa: document.getElementById('fa').checked,
        };

        const btn = document.getElementById('run');
        btn.disabled = true; btn.textContent = 'Running...';
        try {
          const res = await fetch('/sdapi/v1/txt2img', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(body)
          });
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();
          const img = document.createElement('img');
          img.src = 'data:image/png;base64,' + data.images[0];
          img.style.maxWidth = '100%';
          const result = document.getElementById('result');
          result.innerHTML = ''; result.appendChild(img);
        } catch (e) {
          alert(e);
        } finally {
          btn.disabled = false; btn.textContent = 'Generate';
        }
      }

      document.getElementById('run').addEventListener('click', run);
      init();
    </script>
  </body>
  </html>

